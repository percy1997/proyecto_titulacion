<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org"
	xmlns:sec="https://www.thymeleaf.org/thymeleaf-extras-springsecurity6">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Casos Registrados - Cybersafe</title>
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
	<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
	<style>
		body {
			background-color: #f0f2f5;
			min-height: 100vh;
		}

		/* Encabezado de p谩gina */
		.page-header {
			display: flex;
			justify-content: space-between;
			align-items: center;
			margin-bottom: 30px;
			flex-wrap: wrap;
		}

		.page-header h2 {
			color: #006eff;
			font-weight: 700;
		}

		.page-header p {
			color: #555;
			font-size: 0.95rem;
			margin-top: 5px;
		}

		/* Bot贸n registrar */
		.btn-register {
			background: #006eff;
			color: #fff;
			font-weight: 500;
			transition: background 0.3s;
		}

		.btn-register:hover {
			background: #0051b3;
			color: #fff;
		}

		/* Tarjetas de casos */
		.case-card {
			background: #fff;
			border-radius: 12px;
			padding: 20px;
			box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
			transition: transform 0.2s, box-shadow 0.2s;
			cursor: pointer;
			margin-bottom: 20px;
			height: 100%;
			display: flex;
			flex-direction: column;
			justify-content: space-between;
		}

		.case-card:hover {
			transform: translateY(-5px);
			box-shadow: 0 15px 30px rgba(0, 0, 0, 0.15);
		}

		.case-title {
			font-weight: 600;
			color: #002b7a;
			margin-bottom: 10px;
		}

		.case-desc {
			color: #555;
			font-size: 0.95rem;
			flex-grow: 1;
		}

		.case-badge {
			font-size: 0.75rem;
			padding: 0.35em 0.6em;
			border-radius: 12px;
			font-weight: 500;
		}

		.badge-new {
			background-color: #28a745;
			color: #fff;
		}

		.badge-review {
			background-color: #ffc107;
			color: #000;
		}

		.badge-completed {
			background-color: #6c757d;
			color: #fff;
		}

		/* Sidebar */
		.sidebar {
			background: #fff;
			padding: 20px;
			border-radius: 12px;
			box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
			height: fit-content;
			margin-bottom: 20px;
		}

		.sidebar h6 {
			font-weight: 600;
			color: #006eff;
			margin-bottom: 15px;
		}

		/* Paginaci贸n */
		.pagination {
			justify-content: center;
			margin-top: 20px;
		}
	</style>
</head>

<body>

	<!-- NAVBAR -->
	<div th:replace="~{navbar}"></div>

	<!-- CONTENIDO PRINCIPAL -->
	<div class="container my-5">
		<div class="page-header">
			<div>
				<h2>Reportes Registrados</h2>
				<p>Explora los casos reportados por los usuarios. Haz click en cada caso para ver m谩s detalles.</p>
			</div>

			<a sec:authorize="hasAnyRole('Usuario', 'Premium')" href="/est/registrarCiberdelito"
				class="btn btn-register btn-lg px-4 fw-bold shadow-sm d-flex align-items-center gap-2"
				style="border-radius: 10px;">
				<i class="bi bi-plus-circle fs-4"></i>
				Registrar
			</a>
		</div>

		<div class="row">
			<!-- LISTA DE CASOS -->
			<div class="col-lg-9">
				<div class="row g-3">

					<!-- PANEL DE BUSQUEDA -->
					<div sec:authorize="hasAnyRole('Premium', 'Moderador')" class="col-12 mb-4">
						<div class="p-4 bg-white border rounded shadow-sm">
							<h5 class="mb-3 fw-bold text-primary">
								 Buscar Reportes
							</h5>
							<div class="row g-3">
								<div class="col-md-8">
									<input type="text" id="txtBuscar" class="form-control form-control-lg" name="q"
										placeholder="Buscar por t铆tulo o descripci贸n...">
								</div>
								<div class="col-md-4">
									<input type="text" id="txtImplicado" class="form-control form-control-lg"
										name="implicado" placeholder="Presunto implicado...">
								</div>
								<div class="col-md-4">
									<select id="selectModalidad" name="modalidad" class="form-select form-select-lg">
										<option value="">Todas las modalidades</option>
										<option th:each="m : ${listadoModalidad}" th:value="${m.codigoModalidadEstafa}"
											th:text="${m.nombreModalidadEstafa}">
										</option>
									</select>
								</div>
								<div class="col-md-4">
									<select id="selectMedio" name="medio" class="form-select form-select-lg">
										<option value="">Todos los medios</option>
										<option th:each="med : ${listadoMedio}" th:value="${med.codigoMedioEstafa}"
											th:text="${med.nombreMedioEstafa}">
										</option>
									</select>
								</div>
								<div class="col-md-4 d-grid">
									<button id="btnBuscar" class="btn btn-primary btn-lg fw-bold">
										Buscar
									</button>
								</div>

							</div>
						</div>
					</div>

					<!-- Caso 1 -->
					<div id="contenedorCasos">
						<div th:each="fila : ${listadoEstafas}" class="col-md-12">
							<div class="case-card d-flex flex-column flex-md-row align-items-start gap-3"
								th:attr="data-id=${fila.codigoEstafa}">
								<!-- Texto -->
								<div class="flex-grow-1">
									<!-- Modalidad de estafa -->
									<span class="badge bg-success"
										th:text="${fila.modalidadEstafa.nombreModalidadEstafa}"></span>
									<h5 th:text="${fila.tituloCaso}" class="case-title mt-2"></h5>
									<p th:text="${fila.descripcionEstafa}" class="case-desc"></p>
								</div>

								<!-- Imagen -->
								<div th:if="${fila.imagenEstafa != null}" class="text-center flex-shrink-0">
									<img th:src="${fila.imagenEstafa}" alt="Imagen del caso" style="width: 200px; height: 200px; border-radius: 10px; 
						                object-fit: cover; box-shadow: 0 4px 10px rgba(0,0,0,0.1);">
								</div>
							</div>
						</div>
					</div>

					<!--  Caja Premium -->
					<div class="col-md-12 mt-4" sec:authorize="!hasAnyRole('Premium', 'PremiumPlus', 'Moderador')">
						<div class="p-4 text-center border rounded shadow-sm bg-white">
							<h5 class="mb-2">驴Quieres ver m谩s casos?</h5>
							<p class="text-muted mb-3">Desbloquea la versi贸n Premium para acceder al historial completo.
							</p>
							<a href="/dev/premium" class="btn btn-warning fw-bold px-4">Desbloquear Premium</a>
						</div>
					</div>


					<!-- Modal din谩mico de estafa -->
					<div class="modal fade" id="modalCaso" tabindex="-1">
						<div class="modal-dialog modal-lg modal-dialog-centered">
							<div class="modal-content shadow-lg border-0" style="border-radius:15px;">

								<!-- HEADER -->
								<div class="modal-header bg-dark text-white"
									style="border-top-left-radius:15px; border-top-right-radius:15px;">
									<h5 class="modal-title fw-bold" id="modalTituloCaso"></h5>
									<button type="button" class="btn-close btn-close-white"
										data-bs-dismiss="modal"></button>
								</div>

								<!-- BODY -->
								<div class="modal-body">

									<!-- INFO DEL CASO -->
									<div class="mb-3 p-3 bg-light rounded">
										<div class="row g-3">

											<div class="col-md-6">
												<p class="m-0"><i class="bi bi-person-circle text-primary"></i>
													<strong>Usuario:</strong> <span id="modalNickname"></span>
												</p>
											</div>

											<div class="col-md-6">
												<p class="m-0"><i class="bi bi-exclamation-triangle text-warning"></i>
													<strong>Modalidad:</strong> <span id="modalModalidad"></span>
												</p>
											</div>

											<div class="col-md-6">
												<p class="m-0"><i class="bi bi-megaphone text-info"></i>
													<strong>Medio:</strong> <span id="modalMedio"></span>
												</p>
											</div>

											<div class="col-md-6">
												<p class="m-0"><i class="bi bi-person-badge text-danger"></i>
													<strong>Implicado:</strong> <span id="modalImplicado"></span>
												</p>
											</div>

										</div>
									</div>

									<!-- DESCRIPCIN -->
									<div class="mb-3">
										<h6 class="fw-bold">Descripci贸n</h6>
										<p id="modalDescripcion" class="text-muted" style="white-space:pre-line;"></p>
									</div>

									<!-- IMAGEN + BOTN DE REPORTAR -->
									<div style="position: relative;">

										<!-- CONTENEDOR CON ALTURA ESTNDAR -->
										<div id="modalImagenContainer"
											class="mt-3 d-flex justify-content-center align-items-center"
											style="height: 350px; width: 100%; background: #f1f1f1; border-radius: 12px;">

											<img id="modalImagen"
												style="max-height: 100%; max-width: 100%; object-fit: contain;">
										</div>

										<!-- BOTN REPORTAR -->
										<button sec:authorize="hasAnyRole('Usuario', 'Premium')" 
										id="btnReportarCaso" class="btn btn-danger btn-sm shadow"
											style="position:absolute; bottom:10px; right:10px;">
											<i class="bi bi-flag-fill"></i> Reportar caso
										</button>
									</div>
								</div>
							</div>
						</div>
					</div>
					
					<!-- MODAL DE REPORTE -->
					<div class="modal fade" id="modalReporte" tabindex="-1">
					    <div class="modal-dialog modal-dialog-centered">
					        <div class="modal-content">

					            <!-- HEADER -->
					            <div class="modal-header bg-danger text-white">
					                <h5 class="modal-title">Reportar caso</h5>
					                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
					            </div>

					            <!-- BODY -->
					            <div class="modal-body">
					                <label class="form-label fw-bold">Motivo del reporte:</label>
					                <textarea id="motivoReporte" class="form-control" rows="4"
					                          placeholder="Describe el motivo del reporte..."></textarea>
					            </div>

					            <!-- FOOTER -->
					            <div class="modal-footer">
					                <button class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
					                <button id="btnEnviarReporte" class="btn btn-danger">Enviar reporte</button>
					            </div>

					        </div>
					    </div>
					</div>
				</div>
			</div>

			<!-- SIDEBAR / PUBLICIDAD -->
			<div class="col-lg-3">
				<div class="sidebar">
					<h6>Publicidad</h6>
					<p>Coloca aqu铆 banners, anuncios o informaci贸n relevante para los usuarios.</p>
					<hr>
					<p>Enlaces de inter茅s o recomendaciones.</p>
				</div>
			</div>
		</div>

	</div>

	<!-- TOAST: Notificaci贸n de reporte -->
	<div class="position-fixed top-0 start-0 p-3" style="z-index: 2000">
	    <div id="toastReporte" class="toast align-items-center text-white bg-primary border-0">
	        <div class="d-flex">
	            <div class="toast-body" id="toastMensajeReporte">Mensaje aqu铆</div>
	            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
	        </div>
	    </div>
	</div>
	<div th:replace="~{footer}"></div>
	
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

	<!-- CHAT BOT IA -->
	<script type="text/javascript">
		(function (d, t) {
			var v = d.createElement(t), s = d.getElementsByTagName(t)[0];
			v.onload = function () {
				window.voiceflow.chat.load({
					verify: {projectID: '692d2b60bdd0465c265d502f'},
					url: 'https://general-runtime.voiceflow.com/',
					versionID: 'production',
					voice: {
						url: "https://runtime-api.voiceflow.com/"
					}
				});
			}
			v.src = "https://cdn.voiceflow.com/widget-next/bundle.mjs"; v.type = "text/javascript"; s.parentNode.insertBefore(v, s);
		})(document, 'script');
	</script>

	<script>
	document.addEventListener("DOMContentLoaded", function () {

	    const mensaje = sessionStorage.getItem("mensajeReporte");

	    if (mensaje) {
	        document.getElementById("toastMensajeReporte").innerText = mensaje;

	        const toast = new bootstrap.Toast(document.getElementById("toastReporte"));
	        toast.show();

	        sessionStorage.removeItem("mensajeReporte");
	    }

	});
	</script>
	
</body>

</html>
<script th:inline="javascript">
    const ID_USUARIO_LOGEADO = /*[[${idUsuarioLogeado}]]*/ null;
</script>

<script>
let casoSeleccionado = null;

document.addEventListener('DOMContentLoaded', function () {
    const modalCaso = new bootstrap.Modal(document.getElementById('modalCaso'));
    const modalReporte = new bootstrap.Modal(document.getElementById('modalReporte'));

    // Delegaci贸n para abrir el modal del caso (tu c贸digo actual adaptado)
    document.getElementById('contenedorCasos').addEventListener('click', function(e) {
        const card = e.target.closest('.case-card');
        if (!card) return;

        const id = card.getAttribute('data-id');
        casoSeleccionado = id; // guardar ID del caso

        fetch('estafa/' + id)
            .then(res => res.json())
            .then(data => {
                // Llenar modal del caso...
                document.getElementById('modalTituloCaso').innerText = data.titulo;
                document.getElementById('modalModalidad').innerText = data.modalidad;
                document.getElementById('modalMedio').innerText = data.medio;
                document.getElementById('modalDescripcion').innerText = data.descripcion;
                document.getElementById('modalImplicado').innerText = data.implicado;
                document.getElementById('modalNickname').innerText = data.nicknameUsuario;

                const img = document.getElementById('modalImagen');
                const imgContainer = document.getElementById('modalImagenContainer');
                if (data.imagen) {
                    img.src = data.imagen;
                    imgContainer.style.display = "flex";
                } else {
                    imgContainer.style.display = "none";
                }
				
				//  VALIDACIN DEL BOTN REPORTAR
				const btnReportar = document.getElementById('btnReportarCaso');

				console.log(ID_USUARIO_LOGEADO)
				console.log(data.usuarioCreador)

				if (btnReportar) {
				    if (
				        ID_USUARIO_LOGEADO === null ||
				        ID_USUARIO_LOGEADO === data.usuarioCreador
				    ) {
				        btnReportar.style.display = "none";
				    } else {
				        btnReportar.style.display = "block";
				    }
				}

                modalCaso.show();
            });
    });

    // ABRIR MODAL DE REPORTE
    document.getElementById("btnReportarCaso").addEventListener("click", function () {
        modalReporte.show();
    });

	function mostrarToast(mensaje) {
	    document.getElementById("toastMensajeReporte").innerText = mensaje;
	    const toast = new bootstrap.Toast(document.getElementById("toastReporte"));
	    toast.show();
	}
	
	// ENVIAR REPORTE
	document.getElementById("btnEnviarReporte").addEventListener("click", function () {
	    const motivo = document.getElementById("motivoReporte").value;

	    if (!motivo.trim()) {
	        mostrarToast("Debes ingresar un motivo.");
	        return;
	    }

	    fetch("/est/registrarReporte", {
	        method: "POST",
	        headers: { "Content-Type": "application/json" },
	        body: JSON.stringify({
	            idEstafa: casoSeleccionado,
	            motivo: motivo
	        })
	    })
	    .then(res => res.json())
	    .then(data => {

	        // Guardar mensaje para mostrar DESPUS DE refrescar la p谩gina
	        sessionStorage.setItem("mensajeReporte", "Reporte enviado correctamente.");

	        // Limpiar el campo del textarea
	        document.getElementById("motivoReporte").value = "";

	        // Cerrar modal
	        modalReporte.hide();

	        // Refrescar p谩gina
	        window.location.reload();
	    })
	    .catch(err => mostrarToast("Ocurri贸 un error, intenta nuevamente."));
	});

});
</script>
<script>
document.getElementById("btnBuscar").addEventListener("click", function() {

    const params = new URLSearchParams({
        q: document.getElementById("txtBuscar").value,
        implicado: document.getElementById("txtImplicado").value,
        modalidad: document.getElementById("selectModalidad").value,
        medio: document.getElementById("selectMedio").value
    });

    fetch("/est/buscar-casos?" + params.toString())
        .then(r => r.json())
        .then(data => {
            const contenedor = document.getElementById("contenedorCasos");
            contenedor.innerHTML = ""; // limpiar

            if (data.length === 0) {
                contenedor.innerHTML = `
                    <div class="col-12 text-center mt-4">
                        <p class="text-muted">No se encontraron casos.</p>
                    </div>
                `;
                return;
            }

            data.forEach(caso => {
                const card = `
                <div class="col-md-12">
                    <div class="case-card d-flex flex-column flex-md-row align-items-start gap-3" data-id="${caso.codigoEstafa}">
                        
                        <div class="flex-grow-1">
                            <span class="badge bg-success">${caso.modalidadEstafa?.nombreModalidadEstafa ?? ''}</span>
                            <h5 class="case-title mt-2">${caso.tituloCaso}</h5>
                            <p class="case-desc">${caso.descripcionEstafa}</p>
                        </div>

                        <div class="text-center flex-shrink-0">
                            ${caso.imagenEstafa ? `
                                <img src="${caso.imagenEstafa}" style="width: 200px; height: 200px; border-radius: 10px; object-fit: cover; box-shadow:0 4px 10px rgba(0,0,0,0.1);">
                            ` : ''}
                        </div>

                    </div>
                </div>
                `;

                contenedor.insertAdjacentHTML("beforeend", card);
            });
        });
});
</script>
