<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cybersafe - Reportes Estadísticos</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        header {
            background: linear-gradient(135deg, #006eff, #002b7a);
            color: white;
        }
        .hero-title {
            font-size: 3rem;
            font-weight: 800;
        }
        footer {
            background: linear-gradient(90deg, #000, #222);
        }
        .stat-card {
            padding: 20px;
            border-radius: 15px;
        }
    </style>
</head>

<body class="bg-light">

	<!-- NAVBAR -->
	<div th:replace="~{navbar}"></div>

<!-- HEADER -->
<header class="text-center py-5">
    <div class="container py-4">
        <h1 class="hero-title mb-3">REPORTES ESTADÍSTICOS <span class="text-warning">CYBERSAFE</span></h1>
        <p class="lead mb-0">Visualiza las tendencias y evolución de los ciberdelitos reportados.</p>
    </div>
</header>

<!-- CONTENIDO -->
<section class="container py-5">

 

    <!-- ================= PANEL CYBERSAFE ================= -->
    <div id="panel-cybersafe">

        <!-- TARJETAS -->
        <div class="row g-4 mb-5">

            <!-- TOTAL GENERAL -->
            <div class="col-md-4">
                <div class="card shadow-sm stat-card text-center">
                    <p class="text-muted mb-1">Total de Reportes</p>
                    <h3 class="fw-bold" th:text="${totalEstafas}">0</h3>
                </div>
            </div>

            <!-- TOTAL DEL MES ACTUAL -->
            <div sec:authorize="hasRole('Premium')" class="col-md-4">
                <div class="card shadow-sm stat-card text-center">
                    <p class="text-muted mb-1">Total de Reportes en el Mes Actual</p>
                    <h3 class="fw-bold" th:text="${totalMes}">0</h3>
                </div>
            </div>

            <!-- TOTAL DEL AÑO ACTUAL -->
			<div sec:authorize="hasRole('Premium')" class="col-md-4">
                <div class="card shadow-sm stat-card text-center">
                    <p class="text-muted mb-1">Total de Reportes en el Año Actual</p>
                    <h3 class="fw-bold" th:text="${totalAnio}">0</h3>
                </div>
            </div>

        </div>

        <!-- GRÁFICOS BÁSICOS -->
        <div class="row g-4 mb-4">

            <div class="col-md-6">
                <div class="card shadow-sm p-3 rounded-4">
                    <h5 class="fw-bold mb-3">Reportes por Medio</h5>
                    <canvas id="chartMedio" height="600"></canvas>
                </div>
            </div>

            <div sec:authorize="hasRole('Premium')" class="col-md-6">
                <div class="card shadow-sm p-3 rounded-4">
                    <h5 class="fw-bold mb-3">Reportes por Modalidad</h5>
                    <canvas id="chartModalidad" height="350"></canvas>
                </div>
            </div>

        </div>

        <!-- GRÁFICO POR AÑO -->
        <div class="card shadow-sm p-3 rounded-4 mb-5">
            <h5 class="fw-bold mb-3">Reportes por Año</h5>
            <canvas id="chartAnio" height="120"></canvas>
        </div>

        <!-- GRÁFICO POR MES CON COMBO AÑO -->
        <div sec:authorize="hasRole('Premium')" class="card shadow-sm p-3 rounded-4 mb-5">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="fw-bold mb-0">Reportes por Mes</h5>
                <div class="d-flex align-items-center">
                    <label for="selectAnio" class="me-2 mb-0 small text-muted">Año:</label>
                    <select id="selectAnio" class="form-select form-select-sm">
                        <option th:each="row : ${reportesPorAnio}"
                                th:value="${row[0]}"
                                th:text="${row[0]}"
                                th:selected="${row[0]} == ${anioActual}">
                        </option>
                    </select>
                </div>
            </div>
            <canvas id="chartMes" height="120"></canvas>
        </div>

        <!-- TENDENCIA HISTÓRICA -->
        <div sec:authorize="hasRole('Premium')" class="card shadow-sm p-3 rounded-4 mb-5">
            <h5 class="fw-bold mb-3">Tendencia Histórica (Año-Mes)</h5>
            <canvas id="chartTendencia" height="120"></canvas>
        </div>

    </div> <!-- /panel-cybersafe -->

  

</section>

<!-- FOOTER -->
<div th:replace="~{footer}"></div>


<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<!-- CHARTS JS -->
<script th:inline="javascript">
/*<![CDATA[*/

// ===================== DATOS CYBERSAFE (BD) =====================
const datosMedio      = /*[[${estadisticasMedio}]]*/ [];
const datosModalidad  = /*[[${estadisticasModalidad}]]*/ [];
const datosAnio       = /*[[${reportesPorAnio}]]*/ [];
const datosMes        = /*[[${reportesPorMes}]]*/ [];
const datosTendencia  = /*[[${tendenciaHistorica}]]*/ [];
const anioActual      = /*[[${anioActual}]]*/ 0;



const nombresMes = ['Ene','Feb','Mar','Abr','May','Jun','Jul','Ago','Sep','Oct','Nov','Dic'];

document.addEventListener('DOMContentLoaded', function () {

    // ----------------------- BOTONES PANEL -----------------------
    const btnCyber   = document.getElementById('btn-cybersafe');
    const btnNac     = document.getElementById('btn-nacional');
    const panelCyber = document.getElementById('panel-cybersafe');
    const panelNac   = document.getElementById('panel-nacional');

    if (btnCyber && btnNac) {
        btnCyber.addEventListener('click', () => {
            panelCyber.style.display = 'block';
            panelNac.style.display   = 'none';
            btnCyber.classList.add('btn-primary');
            btnCyber.classList.remove('btn-outline-primary');
            btnNac.classList.add('btn-outline-primary');
            btnNac.classList.remove('btn-primary');
        });

        btnNac.addEventListener('click', () => {
            panelCyber.style.display = 'none';
            panelNac.style.display   = 'block';
            btnNac.classList.add('btn-primary');
            btnNac.classList.remove('btn-outline-primary');
            btnCyber.classList.add('btn-outline-primary');
            btnCyber.classList.remove('btn-primary');
        });
    }

    /* =======================================================
       CYBERSAFE: GRAFICO POR MEDIO
       ======================================================= */

    new Chart(document.getElementById('chartMedio'), {
        type: 'bar',
        data: {
            labels: datosMedio.map(e => e[0]),
            datasets: [{
                label: 'Reportes',
                data: datosMedio.map(e => e[1]),
                backgroundColor: '#1d4ed8',
                borderColor: '#ffffff',
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            indexAxis: 'y',
            scales: {
                x: { beginAtZero: true },
                y: { ticks: { autoSkip: false } }
            },
            plugins: {
                legend: { display: false }
            }
        }
    });

    /* =======================================================
       CYBERSAFE: GRAFICO POR MODALIDAD
       ======================================================= */

    new Chart(document.getElementById('chartModalidad'), {
        type: 'pie',
        data: {
            labels: datosModalidad.map(e => e[0]),
            datasets: [{
                label: 'Reportes',
                data: datosModalidad.map(e => e[1]),
                backgroundColor: [
                    '#1d4ed8','#3b82f6','#60a5fa','#93c5fd',
                    '#1e3a8a','#0ea5e9','#38bdf8','#0f766e'
                ],
                borderColor: '#ffffff',
                borderWidth: 2,
                hoverOffset: 10
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: { position: 'top' }
            }
        }
    });

    /* =======================================================
       CYBERSAFE: POR AÑO
       ======================================================= */

    new Chart(document.getElementById('chartAnio'), {
        type: 'bar',
        data: {
            labels: datosAnio.map(e => e[0]),
            datasets: [{
                label: 'Reportes por Año',
                data: datosAnio.map(e => e[1]),
                backgroundColor: '#60a5fa'
            }]
        },
        options: {
            responsive: true,
            scales: { y: { beginAtZero: true } }
        }
    });

    /* =======================================================
       POR MES
       ======================================================= */

    const ctxMes = document.getElementById('chartMes');
    const chartMes = new Chart(ctxMes, {
        type: 'line',
        data: {
            labels: datosMes.map(e => nombresMes[e[0]-1]),
            datasets: [{
                label: 'Reportes por Mes',
                data: datosMes.map(e => e[1]),
                borderColor: '#2563eb',
                backgroundColor: 'rgba(37,99,235,0.2)',
                tension: 0.3
            }]
        },
        options: {
            responsive: true,
            scales: { y: { beginAtZero: true } }
        }
    });

    document.getElementById('selectAnio')?.addEventListener('change', function () {
        const anio = this.value;
        fetch('/dev/estadisticas/meses?anio=' + anio)
            .then(resp => resp.json())
            .then(data => {
                chartMes.data.labels = data.map(e => nombresMes[e[0]-1]);
                chartMes.data.datasets[0].data = data.map(e => e[1]);
                chartMes.update();
            });
    });

    /* =======================================================
       TENDENCIA HISTÓRICA
       ======================================================= */

    new Chart(document.getElementById('chartTendencia'), {
        type: 'line',
        data: {
            labels: datosTendencia.map(e => `${e[0]}-${String(e[1]).padStart(2,'0')}`),
            datasets: [{
                label: 'Tendencia Mensual',
                data: datosTendencia.map(e => e[2]),
                borderColor: '#14b8a6',
                backgroundColor: 'rgba(20,184,166,0.25)',
                tension: 0.25
            }]
        },
        options: {
            responsive: true,
            scales: { y: { beginAtZero: true } }
        }
    });

 

}); 


</script>
<script src="/js/chatbotIA.js"></script>
</body>
</html>
