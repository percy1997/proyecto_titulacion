<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="https://www.thymeleaf.org/thymeleaf-extras-springsecurity6">
<head>
    <meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reportar Estafa Digital</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">

    <style>

        /* Form container centrado */
        .container-form {
            max-width: 580px;
            margin: 80px auto 50px; /* 80px para separarlo del navbar */
            background: white;
            padding: 40px;
            border-radius: 16px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        h1 {
            font-size: 28px;
            font-weight: 600;
            margin-bottom: 8px;
            text-align: center;
            color: #222;
        }

        .subtitle {
            text-align: center;
            font-size: 15px;
            color: #555;
            margin-bottom: 35px;
        }

        input, select, textarea {
            width: 100%;
            padding: 13px;
            border-radius: 10px;
            border: 1px solid #ddd;
            font-size: 14px;
            outline: none;
            transition: all .2s ease;
            background: #fafafa;
        }

        input:focus, select:focus, textarea:focus {
            border-color: #3aa6ff;
            background: #fff;
        }

        textarea { height: 140px; resize: none; }

        .file-box {
            border: 2px dashed #ced4da;
            border-radius: 12px;
            padding: 35px;
            text-align: center;
            color: #666;
            margin-bottom: 20px;
            font-size: 14px;
            background: #fafafa;
        }

        .checkbox-wrapper {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            margin: 12px 0;
            font-size: 14px;
            color: #333;
        }
        .checkbox-wrapper input { width: 18px; height: 18px; margin-top: 2px; cursor: pointer; }
        .checkbox-wrapper label { cursor: pointer; line-height: 1.3; }

        .submit-btn {
            width: 100%;
            padding: 14px;
            background-color: #118ab2;
            border: none;
            border-radius: 10px;
            color: white;
            font-size: 17px;
            cursor: pointer;
            margin-top: 20px;
            transition: background .2s ease;
        }
        .submit-btn:hover { background-color: #0d6c8a; }
        .alerta {
            padding: 15px 20px;
            border-radius: 8px;
            margin-top: 20px;
            font-weight: 500;
            font-size: 14px;
        }
        .alerta-exito { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .alerta-error { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }

        button:disabled { opacity: 0.6; cursor: not-allowed; }

    </style>
</head>
<body class="bg-light">

	<!-- NAVBAR -->
	<div th:replace="~{navbar}"></div>

<!-- FORMULARIO -->
<div class="container-form">
    <h1>REPORTAR ESTAFA DIGITAL</h1>
    <p class="subtitle">Completa la información del incidente y adjunta evidencias para enviarlo.</p>

    <form id="formEstafa" enctype="multipart/form-data">
        <label for="titulo">Título del reporte</label>
        <input type="text" id="titulo" name="titulo" placeholder="Ingrese un título al caso" required>

        <label for="modalidad" style="margin-top: 18px;">Modalidad de estafa</label>
        <select id="modalidad" name="codigoModalidad" required>
            <option value="">-- Selecciona una opción --</option>
            <option th:each="m : ${listadoModalidad}" th:value="${m.codigoModalidadEstafa}" th:text="${m.nombreModalidadEstafa}"></option>
        </select>

        <label for="medio" style="margin-top: 18px;">Medio de estafa</label>
        <select id="medio" name="codigoMedio" required>
            <option value="">-- Selecciona una opción --</option>
            <option th:each="m : ${listadoMedio}" th:value="${m.codigoMedioEstafa}" th:text="${m.nombreMedioEstafa}"></option>
        </select>

        <label for="descripcion" style="margin-top: 18px;">Descripción del incidente</label>
        <textarea maxlength="800" id="descripcion" name="descripcion" placeholder="Escribe los detalles..." required></textarea>

        <input type="file" id="imagen" name="imagen" accept="image/*" required>

        <label for="ciberdelincuente" style="margin-top: 18px;">Presunto implicado</label>
        <input id="ciberdelincuente" name="ciberdelincuente" placeholder="Escribe los detalles..." required>

		<div class="checkbox-wrapper">
		    <input type="checkbox" id="terminos" name="terminos" required>
		    <label for="terminos">
		        Acepto los 
		        <a href="#" data-bs-toggle="modal" data-bs-target="#modalTerminos">
		            términos y condiciones
		        </a>
		        del uso de la plataforma
		    </label>
		</div>

		<div class="d-flex align-items-center gap-3">

		    <!-- CHECKBOX -->
		    <div class="checkbox-wrapper">
		        <input type="checkbox" id="formal" name="formal" th:disabled="${contador == 0}">
		        <label for="formal" class="ms-1">Enviar denuncia formal a la DIVINDAT</label>
		    </div>

		    <!-- BOTÓN “MEJORAR A PREMIUM” -->
		    <a sec:authorize="!hasAnyRole('Premium')"
		            th:if="${contador == 0}"
		            type="button"
		            class="btn btn-warning btn-sm fw-bold"
		            href="/dev/premium">
		        ⭐ Mejorar Premium o Renueva
		    </a>

		</div>

        <button class="submit-btn" type="submit" id="btnEnviar">Enviar Reporte</button>
    </form>

    <div id="mensaje" class="alerta" style="display:none;"></div>
</div>

<div class="modal fade" id="modalTerminos" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content">

            <div class="modal-header bg-dark text-white">
                <h5 class="modal-title">Reglas y Términos de Uso – CyberSafe Perú</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body">
                <p><strong>1. Uso adecuado de la plataforma</strong></p>
                <p>
                    El usuario se compromete a utilizar la plataforma CyberSafe Perú únicamente con fines 
					informativos, preventivos y de reporte de posibles delitos informáticos, absteniéndose de 
					realizar usos malintencionados o fraudulentos.                </p>
                <p><strong>2. Veracidad de la información</strong></p>
                <p>
					El usuario declara que la información ingresada en formularios, reportes y evidencias 
					es verídica, completa y proporcionada de buena fe. CyberSafe Perú no se responsabiliza 
					por información falsa o incompleta ingresada por terceros.
                </p>
                <p><strong>3. Responsabilidad del usuario</strong></p>
                <p>
                    El usuario es responsable del contenido que registra en la plataforma, incluyendo textos, 
					imágenes, archivos o cualquier otro tipo de evidencia digital adjunta.
                </p>

                <p><strong>4. Tratamiento de datos personales</strong></p>
                <p>
                    La información proporcionada será utilizada únicamente para fines de análisis, orientación, 
					generación de estadísticas y, cuando el usuario lo autorice, para la derivación del caso a 
					entidades competentes, respetando la confidencialidad y la normativa vigente sobre 
					protección de datos personales.
                </p>
                <p><strong>5. Anonimización de reportes públicos</strong></p>
                <p>
					Los reportes que se muestren en módulos públicos o estadísticos serán anonimizados, 
					evitando la exposición de datos personales que permitan identificar al usuario.
                </p>
				<p><strong>6. Limitación de responsabilidad</strong></p>
				<p>
					CyberSafe Perú es una plataforma de apoyo, orientación y registro ciudadano. No sustituye 
					las funciones legales de las autoridades competentes ni garantiza la resolución de los 
					casos reportados.
				</p>
				<p><strong>7. Uso de contenidos</strong></p>
				<p>
					Los contenidos informativos, guías y materiales educativos disponibles en la plataforma 
					son de uso referencial y no constituyen asesoría legal oficial.
				</p>
				<p><strong>8. Disponibilidad del servicio</strong></p>
				<p>
					La plataforma puede presentar interrupciones temporales por mantenimiento, mejoras o 
					causas técnicas, sin que ello genere responsabilidad para los administradores del sistema.
				</p>
				<p><strong>9. Modificación de términos</strong></p>
				<p>
					CyberSafe Perú se reserva el derecho de modificar los Términos y Condiciones en cualquier 
					momento. Las modificaciones serán comunicadas a través de la plataforma.
				</p>
				<p><strong>10. Envío a la DIVINDAT</strong></p>
				<p>
					De marcar el envio de mi caso a la DINVINDAT, autorizo el envío de la información registrada, 
					incluyendo las evidencias adjuntas, a la División de Investigación de Delitos de Alta 
					Tecnología (DIVINDAT). Entiendo que CyberSafe Perú actúa únicamente como plataforma de apoyo 
					y no garantiza la atención ni resolución del caso por parte de dicha entidad.
					Declaro que la información proporcionada es verídica y autorizo expresamente a CyberSafe Perú 
					a remitir este reporte, junto con las evidencias adjuntas, a la División de Investigación de 
					Delitos de Alta Tecnología (DIVINDAT) de la Policía Nacional del Perú. Entiendo que CyberSafe 
					Perú no sustituye los canales oficiales de denuncia ni garantiza la atención del caso.
				</p>
            </div>

            <div class="modal-footer">
                <button class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
            </div>

        </div>
    </div>
</div>


<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
document.getElementById("formEstafa").addEventListener("submit", function(e){
    e.preventDefault();
    const form = e.target;
    const formData = new FormData(form);
    const mensajeDiv = document.getElementById("mensaje");
    const btnEnviar = document.getElementById("btnEnviar");

    const elementos = form.querySelectorAll("input, select, textarea, button");
    elementos.forEach(el => el.disabled = true);
    const textoOriginal = btnEnviar.innerText;
    btnEnviar.innerText = "Registrando...";

    fetch("/est/registrar", { method: "POST", body: formData })
    .then(response => response.text())
    .then(data => {
        mensajeDiv.innerText = data;
        mensajeDiv.className = "alerta alerta-exito";
        mensajeDiv.style.display = "block";
        form.reset();
        elementos.forEach(el => el.disabled = false);
        btnEnviar.innerText = textoOriginal;
    })
    .catch(error => {
        console.error(error);
        mensajeDiv.innerText = "Error al registrar la estafa";
        mensajeDiv.className = "alerta alerta-error";
        mensajeDiv.style.display = "block";
        elementos.forEach(el => el.disabled = false);
        btnEnviar.innerText = textoOriginal;
    });
});
</script>
<!-- CHAT BOT IA -->
<script type="text/javascript">
  (function(d, t) {
      var v = d.createElement(t), s = d.getElementsByTagName(t)[0];
      v.onload = function() {
        window.voiceflow.chat.load({
          verify: { projectID: '692d2b60bdd0465c265d502f' },
          url: 'https://general-runtime.voiceflow.com/',
          versionID: 'production',
          voice: {
            url: "https://runtime-api.voiceflow.com/"
          }
        });
      }
      v.src = "https://cdn.voiceflow.com/widget-next/bundle.mjs"; v.type = "text/javascript"; s.parentNode.insertBefore(v, s);
  })(document, 'script');
</script>
</body>
</html>